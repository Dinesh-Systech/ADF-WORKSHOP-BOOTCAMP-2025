{
	"name": "DF_OutletMaster",
	"properties": {
		"folder": {
			"name": "End to End Workshop/Stg to Tgt"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "DS_AzureSql_IN1684",
						"type": "DatasetReference"
					},
					"name": "SRCOutlet"
				},
				{
					"dataset": {
						"referenceName": "DS_AzureSql_IN1684",
						"type": "DatasetReference"
					},
					"name": "TGTOutlet"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DS_AzureSql_IN1684",
						"type": "DatasetReference"
					},
					"name": "SNKOutlet"
				}
			],
			"transformations": [
				{
					"name": "selectSRC"
				},
				{
					"name": "selectTGT"
				},
				{
					"name": "joinSRCComapnyAndTGTCompany"
				},
				{
					"name": "alterInsert"
				},
				{
					"name": "NullHandling"
				},
				{
					"name": "union"
				},
				{
					"name": "OuteltKey"
				},
				{
					"name": "SelectSRCOrder"
				},
				{
					"name": "split1"
				},
				{
					"name": "alterUpdate"
				},
				{
					"name": "Transformation"
				},
				{
					"name": "auditcolumns1"
				},
				{
					"name": "auditcolumns2"
				}
			],
			"scriptLines": [
				"source(output(",
				"          OUTLET_KEY as integer,",
				"          OUTLET_CODE as string,",
				"          OUTLET_NAME as string,",
				"          GEO_KEY as integer,",
				"          STREET as string,",
				"          CITY as string,",
				"          GEO_LONGITUDE as decimal(10,8),",
				"          GEO_LATITUDE as decimal(10,8),",
				"          OUTLET_STATUS as string,",
				"          OWNER_CODE as string,",
				"          OWNER_NAME as string,",
				"          DISTRUBUTOR_CODE as string,",
				"          MARKET_TYPE as string,",
				"          HUB as string,",
				"          CHANNEL as string,",
				"          MICRO_CHANNEL as string,",
				"          GROUP_OUTLET_CODE as string,",
				"          OUTLET_TIER as string,",
				"          IS_ACTIVE as string,",
				"          BUSINESS_UNIT as string,",
				"          SALES_REPRESENTATIVE_CODE as string,",
				"          SALES_TERRITORY as string,",
				"          CONTACT_NAME as string,",
				"          CONTACT_EMAIL as string,",
				"          LICENSE_TYPE as string,",
				"          ACTIVE_FLAG as string,",
				"          DW_CREATED_DATE as timestamp,",
				"          DW_UPDATED_DATE as timestamp,",
				"          DW_CREATED_BY as string,",
				"          DW_UPDATED_BY as string,",
				"          TERRITORY_CODE as string,",
				"          OUTLET_SEGMENT as string,",
				"          OUTLET_START_DATE as timestamp,",
				"          OUTLET_END_DATE as timestamp,",
				"          {Created By} as string,",
				"          {Created Date} as timestamp,",
				"          {Updated By} as string,",
				"          {Updated Date} as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> SRCOutlet",
				"source(output(",
				"          OUTLET_KEY as integer,",
				"          OUTLET_CODE as string,",
				"          OUTLET_NAME as string,",
				"          GEO_KEY as integer,",
				"          STREET as string,",
				"          CITY as string,",
				"          GEO_LONGITUDE as decimal(10,8),",
				"          GEO_LATITUDE as decimal(10,8),",
				"          OUTLET_STATUS as string,",
				"          OWNER_CODE as string,",
				"          OWNER_NAME as string,",
				"          DISTRUBUTOR_CODE as string,",
				"          MARKET_TYPE as string,",
				"          HUB as string,",
				"          CHANNEL as string,",
				"          MICRO_CHANNEL as string,",
				"          GROUP_OUTLET_CODE as string,",
				"          OUTLET_TIER as string,",
				"          IS_ACTIVE as string,",
				"          BUSINESS_UNIT as string,",
				"          SALES_REPRESENTATIVE_CODE as string,",
				"          SALES_TERRITORY as string,",
				"          CONTACT_NAME as string,",
				"          CONTACT_EMAIL as string,",
				"          LICENSE_TYPE as string,",
				"          ACTIVE_FLAG as string,",
				"          DW_CREATED_DATE as timestamp,",
				"          DW_UPDATED_DATE as timestamp,",
				"          DW_CREATED_BY as string,",
				"          DW_UPDATED_BY as string,",
				"          TERRITORY_CODE as string,",
				"          OUTLET_SEGMENT as string,",
				"          OUTLET_START_DATE as timestamp,",
				"          OUTLET_END_DATE as timestamp,",
				"          IsActive as string,",
				"          {Created By} as string,",
				"          {Created Date} as timestamp,",
				"          {Updated By} as string,",
				"          {Updated Date} as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> TGTOutlet",
				"SRCOutlet select(mapColumn(",
				"          each(match(true()),",
				"               \"SRC_\"+$$ = $$)",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectSRC",
				"TGTOutlet select(mapColumn(",
				"          each(match(true()),",
				"               \"TGT_\"+$$ = $$)",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectTGT",
				"selectSRC, selectTGT join(SRC_OUTLET_CODE == TGT_OUTLET_CODE,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinSRCComapnyAndTGTCompany",
				"split1@Insert alterRow(insertIf(true())) ~> alterInsert",
				"union derive(each(match(type == 'string'), $$ = iif(isNull($$) || $$ == 'NULL', 'UNK', $$)),",
				"          each(match(type == 'integer'), $$ = iifNull($#, -1)),",
				"          each(match(type == 'timestamp'), $$ = iifNull($$, toTimestamp('2999-12-31 00:00:00', 'yyyy-MM-dd HH:mm:ss'))),",
				"          each(match(type == 'decimal'), $$ = iifNull($#, 0.00))) ~> NullHandling",
				"auditcolumns1, alterUpdate union(byName: true)~> union",
				"Transformation keyGenerate(output(OutletKey as long),",
				"     startAt: 1L,",
				"     stepValue: 1L) ~> OuteltKey",
				"OuteltKey select(mapColumn(",
				"          OutletKey,",
				"          OUTLET_CODE = SRC_OUTLET_CODE,",
				"          OUTLET_NAME = SRC_OUTLET_NAME,",
				"          GEO_KEY = SRC_GEO_KEY,",
				"          STREET = SRC_STREET,",
				"          CITY = SRC_CITY,",
				"          GEO_LONGITUDE = SRC_GEO_LONGITUDE,",
				"          GEO_LATITUDE = SRC_GEO_LATITUDE,",
				"          OUTLET_STATUS = SRC_OUTLET_STATUS,",
				"          OWNER_CODE = SRC_OWNER_CODE,",
				"          OWNER_NAME = SRC_OWNER_NAME,",
				"          DISTRUBUTOR_CODE = SRC_DISTRUBUTOR_CODE,",
				"          MARKET_TYPE = SRC_MARKET_TYPE,",
				"          HUB = SRC_HUB,",
				"          CHANNEL = SRC_CHANNEL,",
				"          MICRO_CHANNEL = SRC_MICRO_CHANNEL,",
				"          GROUP_OUTLET_CODE = SRC_GROUP_OUTLET_CODE,",
				"          OUTLET_TIER = SRC_OUTLET_TIER,",
				"          IS_ACTIVE = SRC_IS_ACTIVE,",
				"          BUSINESS_UNIT = SRC_BUSINESS_UNIT,",
				"          SALES_REPRESENTATIVE_CODE = SRC_SALES_REPRESENTATIVE_CODE,",
				"          SALES_TERRITORY = SRC_SALES_TERRITORY,",
				"          CONTACT_NAME = SRC_CONTACT_NAME,",
				"          CONTACT_EMAIL = SRC_CONTACT_EMAIL,",
				"          LICENSE_TYPE = SRC_LICENSE_TYPE,",
				"          ACTIVE_FLAG = SRC_ACTIVE_FLAG,",
				"          DW_CREATED_DATE = SRC_DW_CREATED_DATE,",
				"          DW_UPDATED_DATE = SRC_DW_UPDATED_DATE,",
				"          DW_CREATED_BY = SRC_DW_CREATED_BY,",
				"          DW_UPDATED_BY = SRC_DW_UPDATED_BY,",
				"          TERRITORY_CODE = SRC_TERRITORY_CODE,",
				"          OUTLET_SEGMENT = SRC_OUTLET_SEGMENT,",
				"          OUTLET_START_DATE = SRC_OUTLET_START_DATE,",
				"          OUTLET_END_DATE = SRC_OUTLET_END_DATE,",
				"          IsActive,",
				"          {Created By} = {SRC_Created By},",
				"          {Created Date} = {SRC_Created Date},",
				"          {Updated By} = {SRC_Updated By},",
				"          {Updated Date} = {SRC_Updated Date}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> SelectSRCOrder",
				"joinSRCComapnyAndTGTCompany split(isNull(TGT_OUTLET_CODE) || (SRC_OUTLET_CODE == TGT_OUTLET_CODE && (SRC_OUTLET_STATUS != TGT_OUTLET_STATUS || SRC_OWNER_CODE != TGT_OWNER_CODE || SRC_OWNER_NAME != TGT_OWNER_NAME)),",
				"     (SRC_OUTLET_CODE == TGT_OUTLET_CODE && (SRC_OUTLET_STATUS != TGT_OUTLET_STATUS || SRC_OWNER_CODE != TGT_OWNER_CODE || SRC_OWNER_NAME != TGT_OWNER_NAME)),",
				"     disjoint: true) ~> split1@(Insert, Update)",
				"split1@Update alterRow(updateIf(true())) ~> alterUpdate",
				"NullHandling derive({SRC_Updated Date} = toTimestamp(\"2999-12-31 00:00:00\",\"yyyy-MM-dd HH:mm:ss\")) ~> Transformation",
				"alterInsert derive({SRC_Created By} = \"IN1684\",",
				"          {SRC_Created Date} = currentTimestamp(),",
				"          {SRC_Updated By} = \"UNK\",",
				"          {SRC_Updated Date} = toTimestamp(\"2999-12-31 00:00:00\", \"yyyy-MM-dd HH:mm:ss\"),",
				"          IsActive = \"Y\") ~> auditcolumns1",
				"alterUpdate derive({SRC_Updated By} = \"IN1684\",",
				"          {SRC_Updated Date} = currentTimestamp(),",
				"          IsActive = \"N\") ~> auditcolumns2",
				"SelectSRCOrder sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:(true()),",
				"     upsertable:false,",
				"     keys:['OUTLET_STATUS','OWNER_NAME','OWNER_CODE'],",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          OutletKey,",
				"          OUTLET_CODE,",
				"          OUTLET_NAME,",
				"          GEO_KEY,",
				"          STREET,",
				"          CITY,",
				"          GEO_LONGITUDE,",
				"          GEO_LATITUDE,",
				"          OUTLET_STATUS,",
				"          OWNER_CODE,",
				"          OWNER_NAME,",
				"          DISTRUBUTOR_CODE,",
				"          MARKET_TYPE,",
				"          HUB,",
				"          CHANNEL,",
				"          MICRO_CHANNEL,",
				"          GROUP_OUTLET_CODE,",
				"          OUTLET_TIER,",
				"          IS_ACTIVE,",
				"          BUSINESS_UNIT,",
				"          SALES_REPRESENTATIVE_CODE,",
				"          SALES_TERRITORY,",
				"          CONTACT_NAME,",
				"          CONTACT_EMAIL,",
				"          LICENSE_TYPE,",
				"          ACTIVE_FLAG,",
				"          DW_CREATED_DATE,",
				"          DW_UPDATED_DATE,",
				"          DW_CREATED_BY,",
				"          DW_UPDATED_BY,",
				"          TERRITORY_CODE,",
				"          OUTLET_SEGMENT,",
				"          OUTLET_START_DATE,",
				"          OUTLET_END_DATE,",
				"          IsActive,",
				"          {Created By},",
				"          {Created Date},",
				"          {Updated By},",
				"          {Updated Date}",
				"     )) ~> SNKOutlet"
			]
		}
	}
}